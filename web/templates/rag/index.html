<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="Ask Amazon SP-API questions" />
        <title>RAG - Amazon SP-API Assistant</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <!-- Google fonts-->
        <link rel="preconnect" href="https://fonts.gstatic.com" />
        <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,600;1,600&amp;display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,300;0,500;0,600;0,700;1,300;1,500;1,600;1,700&amp;display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;1,400&amp;display=swap" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="static/styles.css" rel="stylesheet" />
    </head>
    <body id="page-top">
        <main class="rag-app" aria-live="polite">
            <div class="container px-5">
                <div class="row justify-content-center">
                    <div class="col-lg-10 col-xl-8">
                        <div class="card shadow rag-card">
                            <div class="card-body p-4 p-lg-5">
                                <h1 class="fw-bold mb-3">Amazon SP-API RAG Assistant</h1>
                                <p class="text-muted mb-4">
                                    Ask any question about Amazon Selling Partner projects, feature toggles, pilot customers, or rate limits. We search the local knowledge base and the official docs you configured, then respond with cited answers.
                                </p>
                                
                                <!-- Add Source Section -->
                                <div class="mb-4">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#addSourceCollapse" aria-expanded="false">
                                        <i class="bi-plus-circle"></i> Add Source (Text or URL)
                                    </button>
                                    <div class="collapse mt-3" id="addSourceCollapse">
                                        <div class="card card-body">
                                            <form id="addSourceFormElement" autocomplete="off">
                                                <div class="mb-3">
                                                    <label class="form-label" for="sourceTitle">Title (optional)</label>
                                                    <input type="text" class="form-control" id="sourceTitle" placeholder="e.g. API Documentation">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label" for="sourceURL">URL (optional)</label>
                                                    <input type="url" class="form-control" id="sourceURL" placeholder="https://example.com/docs">
                                                    <small class="form-text text-muted">Leave empty if adding text directly</small>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label" for="sourceContent">Content</label>
                                                    <textarea class="form-control" id="sourceContent" rows="6" placeholder="Paste your text content here, or leave empty if using URL"></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-primary" id="addSourceBtn">
                                                    <span class="default-label">Add Source</span>
                                                    <span class="loading-label d-none">
                                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                                        Processing...
                                                    </span>
                                                </button>
                                            </form>
                                            <div id="addSourceStatus" class="mt-2"></div>
                                        </div>
                                    </div>
                                </div>

                                <form id="ragForm" class="rag-form" autocomplete="off">
                                    <label class="form-label fw-semibold" for="question">Question</label>
                                    <textarea class="form-control" id="question" name="question" rows="4" placeholder="e.g. How should we handle SP-API rate limits for FBA orders?" required></textarea>
                                    <div class="rag-form__controls">
                                        <div>
                                            <label class="form-label" for="topK">Context chunks</label>
                                            <input class="form-control" type="number" id="topK" name="topK" min="1" max="8" value="4" />
                                        </div>
                                        <button class="btn btn-primary btn-lg rag-submit" type="submit">
                                            <span class="default-label">Ask</span>
                                            <span class="loading-label">
                                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                                Gathering context...
                                            </span>
                                        </button>
                                    </div>
                                </form>
                                <div id="ragStatus" class="rag-status" role="status" aria-live="polite"></div>
                                <section id="ragResults" class="rag-results d-none">
                                    <h2 class="h4 fw-bold">Answer</h2>
                                    <div id="ragAnswer" class="rag-answer"></div>
                                    <div>
                                        <h3 class="h5 mt-4">Sources</h3>
                                        <ul id="ragSources" class="rag-sources"></ul>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            const ragForm = document.getElementById("ragForm");
            const questionInput = document.getElementById("question");
            const topKInput = document.getElementById("topK");
            const resultsSection = document.getElementById("ragResults");
            const answerEl = document.getElementById("ragAnswer");
            const sourcesEl = document.getElementById("ragSources");
            const statusEl = document.getElementById("ragStatus");
            const submitButton = document.querySelector(".rag-submit");

            function setLoading(isLoading) {
                submitButton.disabled = isLoading;
                submitButton.classList.toggle("rag-submit--loading", isLoading);
            }

            ragForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                const question = questionInput.value.trim();
                if (!question) {
                    statusEl.textContent = "Please enter a question.";
                    statusEl.classList.remove("text-success");
                    statusEl.classList.add("text-danger");
                    return;
                }

                const topK = parseInt(topKInput.value, 10) || 4;
                setLoading(true);
                statusEl.textContent = "";
                statusEl.className = "rag-status";
                resultsSection.classList.add("d-none");

                try {
                    const response = await fetch("/api/rag/query", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ question, topK })
                    });

                    if (!response.ok) {
                        const text = await response.text();
                        throw new Error(text || "Failed to fetch answer");
                    }

                    const data = await response.json();
                    answerEl.textContent = data.answer || "No answer returned.";
                    sourcesEl.innerHTML = "";
                    (data.sources || []).forEach((src) => {
                        const li = document.createElement("li");
                        li.innerHTML = `<strong>${src.title || "Source"}</strong><br/><a href="${src.uri}" target="_blank" rel="noreferrer">${src.uri}</a><br/><small>Score: ${src.score?.toFixed?.(3) ?? "-"}</small><p>${src.snippet || ""}</p>`;
                        sourcesEl.appendChild(li);
                    });
                    resultsSection.classList.remove("d-none");
                    statusEl.textContent = "Answer ready.";
                    statusEl.classList.add("text-success");
                } catch (err) {
                    console.error(err);
                    statusEl.textContent = err.message || "Something went wrong.";
                    statusEl.classList.add("text-danger");
                } finally {
                    setLoading(false);
                }
            });

            // Add Source Form Handler
            const addSourceFormEl = document.getElementById("addSourceFormElement");
            const addSourceBtn = document.getElementById("addSourceBtn");
            const addSourceStatus = document.getElementById("addSourceStatus");

            if (addSourceFormEl && addSourceBtn) {
                addSourceFormEl.addEventListener("submit", async (event) => {
                    event.preventDefault();
                    const titleEl = document.getElementById("sourceTitle");
                    const urlEl = document.getElementById("sourceURL");
                    const contentEl = document.getElementById("sourceContent");
                    
                    if (!titleEl || !urlEl || !contentEl) {
                        console.error("Form elements not found");
                        return;
                    }
                    
                    const title = titleEl.value.trim();
                    const url = urlEl.value.trim();
                    const content = contentEl.value.trim();

                    if (!url && !content) {
                        addSourceStatus.innerHTML = '<div class="alert alert-danger">Please provide either a URL or content.</div>';
                        return;
                    }

                    const defaultLabel = addSourceBtn.querySelector(".default-label");
                    const loadingLabel = addSourceBtn.querySelector(".loading-label");
                    addSourceBtn.disabled = true;
                    if (defaultLabel) defaultLabel.classList.add("d-none");
                    if (loadingLabel) loadingLabel.classList.remove("d-none");
                    addSourceStatus.innerHTML = "";

                    try {
                        // Build payload - only include non-empty values
                        const payload = {};
                        if (title) payload.title = title;
                        if (url) payload.url = url;
                        if (content) payload.content = content;
                        
                        console.log("Sending payload:", payload);
                        console.log("URL value:", url, "Content length:", content.length);
                        
                        if (!payload.url && !payload.content) {
                            addSourceStatus.innerHTML = '<div class="alert alert-danger">Please provide either a URL or content.</div>';
                            addSourceBtn.disabled = false;
                            if (defaultLabel) defaultLabel.classList.remove("d-none");
                            if (loadingLabel) loadingLabel.classList.add("d-none");
                            return;
                        }
                        
                        const response = await fetch("/api/rag/add-source", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const text = await response.text();
                            throw new Error(text || "Failed to add source");
                        }

                        const data = await response.json();
                        addSourceStatus.innerHTML = '<div class="alert alert-success">✅ Source added successfully! You can now ask questions about it.</div>';
                        addSourceFormEl.reset();
                        
                        // Collapse form after success
                        setTimeout(() => {
                            const collapseEl = document.getElementById("addSourceCollapse");
                            if (collapseEl) {
                                const bsCollapse = bootstrap.Collapse.getInstance(collapseEl) || new bootstrap.Collapse(collapseEl, {toggle: false});
                                bsCollapse.hide();
                            }
                        }, 2000);
                    } catch (err) {
                        console.error("Error adding source:", err);
                        addSourceStatus.innerHTML = `<div class="alert alert-danger">❌ Error: ${err.message}</div>`;
                    } finally {
                        addSourceBtn.disabled = false;
                        if (defaultLabel) defaultLabel.classList.remove("d-none");
                        if (loadingLabel) loadingLabel.classList.add("d-none");
                    }
                });
            } else {
                console.error("Add source form elements not found");
            }
        </script>
        <!-- Bootstrap JS for collapse -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
