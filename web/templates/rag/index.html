<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="Ask Amazon SP-API questions" />
        <title>Amazon Copilot | Trip Frame</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <!-- Google fonts-->
        <link rel="preconnect" href="https://fonts.gstatic.com" />
        <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,600;1,600&amp;display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,300;0,500;0,600;0,700;1,300;1,500;1,600;1,700&amp;display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;1,400&amp;display=swap" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="static/styles.css" rel="stylesheet" />
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light fixed-top shadow-sm" id="mainNav">
            <div class="container px-5">
                <a class="navbar-brand fw-bold" href="/">Trip Frame</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="bi-list"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto me-4 my-3 my-lg-0">
                        {{ range .HeaderLinksTab }}
                        <li class="nav-item"><a class="nav-link me-lg-3" href="/about">{{ .About }}</a></li>
                        <li class="nav-item"><a class="nav-link me-lg-3" href="/contact">{{ .Contact }}</a></li>
                        <li class="nav-item"><a class="nav-link me-lg-3" href="/login">{{ .Login }}</a></li>
                        {{ end }}
                        <li class="nav-item"><a class="nav-link me-lg-3 active" href="/rag">Amazon Copilot</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <main class="rag-app" aria-live="polite">
            <div class="container px-5">
                <div class="row justify-content-center">
                    <div class="col-lg-10 col-xl-8">
                        <div class="card shadow rag-card">
                            <div class="card-body p-4 p-lg-5">
                                <h1 class="fw-bold mb-3">Amazon project copilot</h1>
                                <p class="text-muted mb-4">
                                    Ask any question about Amazon Selling Partner projects, feature toggles, pilot customers, or rate limits. We search the local knowledge base and the official docs you configured, then respond with cited answers.
                                </p>
                                <form id="ragForm" class="rag-form" autocomplete="off">
                                    <label class="form-label fw-semibold" for="question">Question</label>
                                    <textarea class="form-control" id="question" name="question" rows="4" placeholder="e.g. How should we handle SP-API rate limits for FBA orders?" required></textarea>
                                    <div class="rag-form__controls">
                                        <div>
                                            <label class="form-label" for="topK">Context chunks</label>
                                            <input class="form-control" type="number" id="topK" name="topK" min="1" max="8" value="4" />
                                        </div>
                                        <button class="btn btn-primary btn-lg rag-submit" type="submit">
                                            <span class="default-label">Ask Amazon</span>
                                            <span class="loading-label">
                                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                                Gathering context...
                                            </span>
                                        </button>
                                    </div>
                                </form>
                                <div id="ragStatus" class="rag-status" role="status" aria-live="polite"></div>
                                <section id="ragResults" class="rag-results d-none">
                                    <h2 class="h4 fw-bold">Answer</h2>
                                    <div id="ragAnswer" class="rag-answer"></div>
                                    <div>
                                        <h3 class="h5 mt-4">Sources</h3>
                                        <ul id="ragSources" class="rag-sources"></ul>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="bg-black text-center py-4">
            <div class="container px-5">
                <div class="text-white-50 small">&copy; Trip Frame 2025.</div>
            </div>
        </footer>

        <script>
            const ragForm = document.getElementById("ragForm");
            const questionInput = document.getElementById("question");
            const topKInput = document.getElementById("topK");
            const resultsSection = document.getElementById("ragResults");
            const answerEl = document.getElementById("ragAnswer");
            const sourcesEl = document.getElementById("ragSources");
            const statusEl = document.getElementById("ragStatus");
            const submitButton = document.querySelector(".rag-submit");

            function setLoading(isLoading) {
                submitButton.disabled = isLoading;
                submitButton.classList.toggle("rag-submit--loading", isLoading);
            }

            ragForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                const question = questionInput.value.trim();
                if (!question) {
                    statusEl.textContent = "Please enter a question.";
                    statusEl.classList.remove("text-success");
                    statusEl.classList.add("text-danger");
                    return;
                }

                const topK = parseInt(topKInput.value, 10) || 4;
                setLoading(true);
                statusEl.textContent = "";
                statusEl.className = "rag-status";
                resultsSection.classList.add("d-none");

                try {
                    const response = await fetch("/api/rag/query", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ question, topK })
                    });

                    if (!response.ok) {
                        const text = await response.text();
                        throw new Error(text || "Failed to fetch answer");
                    }

                    const data = await response.json();
                    answerEl.textContent = data.answer || "No answer returned.";
                    sourcesEl.innerHTML = "";
                    (data.sources || []).forEach((src) => {
                        const li = document.createElement("li");
                        li.innerHTML = `<strong>${src.title || "Source"}</strong><br/><a href="${src.uri}" target="_blank" rel="noreferrer">${src.uri}</a><br/><small>Score: ${src.score?.toFixed?.(3) ?? "-"}</small><p>${src.snippet || ""}</p>`;
                        sourcesEl.appendChild(li);
                    });
                    resultsSection.classList.remove("d-none");
                    statusEl.textContent = "Answer ready.";
                    statusEl.classList.add("text-success");
                } catch (err) {
                    console.error(err);
                    statusEl.textContent = err.message || "Something went wrong.";
                    statusEl.classList.add("text-danger");
                } finally {
                    setLoading(false);
                }
            });
        </script>
    </body>
</html>
